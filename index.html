<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My HandHeld GPS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 24px; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; width: 320px; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    label { font-size: .9rem; color: #374151; display: block; margin-bottom: 4px; }
    input, button, textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #d1d5db; }
    input:focus, button:focus, textarea:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,.15); }
    .status { text-align: center; margin-top: 12px; padding: 8px 0; }
    .result-box { background: #f3f4f6; padding: 8px 12px; border-radius: 8px; margin-top: 12px; }
    .copyable { cursor: pointer; color: blue; }
    .btn { cursor: pointer; border: 1px solid #d1d5db; background: #111827; color: #fff; }
    .btn.green { background-color: #4caf50; color: white; padding: 15px; border-radius: 50%; margin: 20px auto; font-size: 16px; }
    .btn.secondary { background: #f3f4f6; color: #111827; }
    .circular-button { border-radius: 50%; width: 80px; height: 80px; background-color: #f3f4f6; color: black; font-size: 24px; display: flex; justify-content: center; align-items: center; cursor: pointer; margin: 20px auto; }
    .csv-box { margin-top: 20px; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>My Handheld GPS</h1>

  <div class="card">
    <div class="grid">
      <div>
        <label for="accuracy">Accuracy (m)</label>
        <input id="accuracy" type="number" step="0.1" placeholder="Accuracy" readonly />
      </div>
      <div>
        <label for="description">Description</label>
        <textarea id="description" placeholder="Enter description" rows="1" maxlength="10" readonly></textarea>
      </div>

      <!-- Circular Button to Pick Coordinates -->
      <div class="circular-button" id="pick-btn">PICK</div>

      <!-- Dynamic Fields for Northing, Easting, and Height -->
      <div>
        <label for="northing">Northing (N)</label>
        <input id="northing" type="number" step="0.000001" placeholder="Northing" readonly />
      </div>
      <div>
        <label for="easting">Easting (E)</label>
        <input id="easting" type="number" step="0.000001" placeholder="Easting" readonly />
      </div>
      <div>
        <label for="height">Height (m)</label>
        <input id="height" type="number" step="0.1" placeholder="Height (m)" readonly />
      </div>

      <div class="status">
        <span id="status" class="pill">Waiting for GPS fix...</span>
      </div>

      <div class="result-box" id="result-box">
        <!-- Display the result here -->
      </div>

      <!-- Download CSV Button -->
      <button class="btn secondary" id="download-btn">Download CSV</button>

      <div id="error-message" class="error"></div>
    </div>
  </div>

  <script>
    const storedCoordinates = [];
    let descriptionCount = 1; // Incremental counter for description

    function ddToUTM(lat, lon) {
      const a = 6378137.0;
      const f = 1 / 298.257223563;
      const k0 = 0.9996;
      const e = Math.sqrt(f * (2 - f));

      const zone = Math.floor((lon + 180) / 6) + 1;
      const lambda0 = ((zone - 1) * 6 - 180 + 3) * Math.PI / 180;

      const phi = lat * Math.PI / 180;
      const lambda = lon * Math.PI / 180;

      const n = a / Math.sqrt(1 - Math.pow(e * Math.sin(phi), 2));
      const t = Math.pow(Math.tan(phi), 2);
      const c = Math.pow(e, 2) / (1 - Math.pow(e, 2)) * Math.pow(Math.cos(phi), 2);
      const A = Math.cos(phi) * (lambda - lambda0);

      const m = a * ((1 - Math.pow(e, 2)/4 - 3*Math.pow(e, 4)/64 - 5*Math.pow(e, 6)/256) * phi
                  - (3*Math.pow(e, 2)/8 + 3*Math.pow(e, 4)/32 + 45*Math.pow(e, 6)/1024) * Math.sin(2*phi)
                  + (15*Math.pow(e, 4)/256 + 45*Math.pow(e, 6)/1024) * Math.sin(4*phi)
                  - (35*Math.pow(e, 6)/3072) * Math.sin(6*phi));

      const easting = 500000 + k0 * n * (A + (1 - t + c) * Math.pow(A, 3)/6 +
                        (5 - 18*t + t*t + 72*c - 58*(Math.pow(e, 2)/(1 - Math.pow(e, 2)))) * Math.pow(A, 5)/120);

      const northing = k0 * (m + n * Math.tan(phi) * (Math.pow(A, 2)/2 +
                         (5 - t + 9*c + 4*c*c) * Math.pow(A, 4)/24 +
                         (61 - 58*t + t*t + 600*c - 330*(Math.pow(e, 2)/(1 - Math.pow(e, 2)))) * Math.pow(A, 6)/720));

      const northingAdjusted = lat < 0 ? northing + 10000000 : northing;
      const hemisphere = lat < 0 ? 'S' : 'N';

      return {
        zone: zone + hemisphere,
        easting: easting.toFixed(3),
        northing: northingAdjusted.toFixed(3)
      };
    }

    function handleGeoSuccess(pos) {
      const c = pos.coords;
      console.log('Geolocation Success:', c);

      const height = (c.altitude !== null && c.altitude !== undefined) ? c.altitude : 'N/A';

      const result = ddToUTM(c.latitude, c.longitude);

      const accuracy = c.accuracy;

      // Set the height and round to 3 decimal places
      document.getElementById('height').value = parseFloat(height).toFixed(3); // Rounded to 3 decimal places
      document.getElementById('accuracy').value = accuracy.toFixed(0);
      document.getElementById('northing').value = result.northing;
      document.getElementById('easting').value = result.easting;

      document.getElementById('result-box').innerHTML = `
        <p><strong>UTM Easting:</strong> ${result.easting}</p>
        <p><strong>UTM Northing:</strong> ${result.northing}</p>
        <p><strong>Height (m):</strong> ${parseFloat(height).toFixed(3)}</p>
        <p><strong>Zone:</strong> ${result.zone}</p>
      `;

      // Change background color and button color based on accuracy
      if (accuracy < 11) {
        document.body.style.backgroundColor = '#a5d6a7'; // Darker green
        document.getElementById('pick-btn').style.backgroundColor = '#388e3c'; // Dark green button
        document.getElementById('pick-btn').style.color = '#800080'; // Purple text color for "PICK"
      } else if (accuracy < 31) {
        document.body.style.backgroundColor = '#FFA500'; // Light orange color
        document.getElementById('pick-btn').style.backgroundColor = '#FF5733'; // Dark orange button
        document.getElementById('pick-btn').style.color = '#800080'; // Purple text color for "PICK"
      } else {
        document.body.style.backgroundColor = '#F9FAFB'; // Default background color
        document.getElementById('pick-btn').style.backgroundColor = '#f3f4f6'; // Default gray button
      }

      document.getElementById('status').textContent = 'GPS Tracking';
    }

    function handleGeoError(err) {
      const errorMsg = {
        1: 'Permission denied. Enable location for this page.',
        2: 'Position unavailable. Move to open sky, enable GPS.',
        3: 'Timeout. Try again.'
      };
      document.getElementById('status').textContent = errorMsg[err.code] || 'Geolocation error.';
    }

    // Start tracking location automatically on load
    function startTracking() {
      if ('geolocation' in navigator) {
        navigator.geolocation.watchPosition(handleGeoSuccess, handleGeoError, {
          enableHighAccuracy: true,
          timeout: 20000,
          maximumAge: 0
        });
      } else {
        document.getElementById('status').textContent = 'Geolocation not supported in this browser.';
      }
    }

    // Store coordinates when pick button is clicked
    document.getElementById('pick-btn').addEventListener('click', function() {
      const description = `A${descriptionCount++}`; // Incremental description A1, A2, A3, etc.
      document.getElementById('description').value = description; // Update the description field

      const accuracy = document.getElementById('accuracy').value;

      if (accuracy) {
        storedCoordinates.push({
          description: description,
          accuracy: accuracy,
          northing: document.getElementById('northing').value,
          easting: document.getElementById('easting').value,
          height: document.getElementById('height').value,
          timestamp: new Date().toISOString()
        });
        alert('Coordinates stored!');
      } else {
        alert('Please wait for a valid GPS fix.');
      }
    });

    // Download stored coordinates as CSV
    document.getElementById('download-btn').addEventListener('click', function() {
      if (storedCoordinates.length === 0) {
        alert('No coordinates stored yet.');
        return;
      }

      let csvContent = 'Description,Accuracy,Northing,Easting,Height,Timestamp\n';
      storedCoordinates.forEach(function(coord) {
        csvContent += `${coord.description},${coord.accuracy},${coord.northing},${coord.easting},${coord.height},${coord.timestamp}\n`;
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'coordinates.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // Start tracking when the page loads
    startTracking();
  </script>
</body>
</html>


